(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{107:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=r.a.createContext({}),c=function(e){var t=r.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},u=function(e){var t=c(e.components);return r.a.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},b=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=c(n),b=a,h=u["".concat(i,".").concat(b)]||u[b]||m[b]||o;return n?r.a.createElement(h,s(s({ref:t},p),{},{components:n})):r.a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=b;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var p=2;p<o;p++)i[p]=n[p];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}b.displayName="MDXCreateElement"},88:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return c}));var a=n(2),r=n(6),o=(n(0),n(107)),i={title:"Moving on with Foreman",author:"Jeremy Hager",author_url:"https://github.com/jeremyhager/",author_image_url:"https://avatars2.githubusercontent.com/u/47301461?s=460&u=05e044dcce4be18b670f9e2c9bda99c511cd4009&v=4",tags:["Website","Foreman","Katello"],description:"Troubleshooting Katello backups and virsh"},s={permalink:"/blog/2020/09/01/Moving-on-with-forman",editUrl:"https://github.com/jeremyhager/yugawa-website/edit/master/blog/2020-09-01-Moving-on-with-forman.md",source:"@site/blog\\2020-09-01-Moving-on-with-forman.md",description:"Troubleshooting Katello backups and virsh",date:"2020-09-01T00:00:00.000Z",tags:[{label:"Website",permalink:"/blog/tags/website"},{label:"Foreman",permalink:"/blog/tags/foreman"},{label:"Katello",permalink:"/blog/tags/katello"}],title:"Moving on with Foreman",readingTime:4.85,truncated:!0,nextItem:{title:"Polishing the website",permalink:"/blog/2020/08/24/Polishing-the-website"}},l=[{value:"Importing errata",id:"importing-errata",children:[]},{value:"Restoring the Foreman vm",id:"restoring-the-foreman-vm",children:[]},{value:"How&#39;s Linux going?",id:"hows-linux-going",children:[]},{value:"Sources",id:"sources",children:[]}],p={rightToc:l};function c(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("img",{src:"/img/light-half-full.jpg",width:"256"}),Object(o.b)("p",null,"Foreman has been giving me a little trouble as I began to set it up. First thing that happened is I could not import errata correctly, and I tried 2 different scripts out there to accomplish it. After several re-tries, I figured a fresh start would be good and reverted the Foreman VM back to before all of these changes happened."),Object(o.b)("p",null,"Well after going through the process again, I unfortunately ran into another issue: I tried to back up the server. I went through the entire process of importing GPG keys, syncing repos, publishing, etc. Following the guide I found ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.lisenet.com/2018/katello-create-products-repositories-content-views-lifecycle-environments-activation-keys/"}),"here"),", step 12 is to use ",Object(o.b)("inlineCode",{parentName:"p"},"katello-backup"),". However the new version of this is ",Object(o.b)("inlineCode",{parentName:"p"},"foreman-maintain"),"."),Object(o.b)("p",null,"Eventually I found the right command: ",Object(o.b)("inlineCode",{parentName:"p"},"sudo foreman-maintain backup offline /mnt/backup"),". Everything seemed to go okay..."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"Starting backup: 2020-08-25 18:13:10 -0400\nRunning preparation steps required to run the next scenarios\n================================================================================\nMake sure Foreman DB is up:\n/ Checking connection to the Foreman DB                               [OK]\n--------------------------------------------------------------------------------\n\n\nRunning Backup\n================================================================================\nConfirm turning off services is allowed:\nWARNING: This script will stop your services.\n\nDo you want to proceed?, [y(yes), q(quit)] y\n                                                                      [OK]\n--------------------------------------------------------------------------------\nPrepare backup Directory:\nCreating backup folder /mnt/backup/katello-backup-2020-08-25-18-13-10 [OK]\n--------------------------------------------------------------------------------\nCheck if the directory exists and is writable:                        [OK]\n--------------------------------------------------------------------------------\n.\n.\n.\n#etc.\n")),Object(o.b)("p",null,"But then this hit me:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"Backup Candlepin DB offline:\n/ Collecting data from /var/opt/rh/rh-postgresql12/lib/pgsql/data/    [FAIL]\nFailed executing tar --selinux --create --file=/mnt/backup/katello-backup-2020-08-25-18-13-10/pgsql_data.tar --listed-incremental=/mnt/backup/katello-backup-2020-08-25-18-13-10/.postgres.snar --transform 's,^,var/opt/rh/rh-postgresql12/lib/pgsql/data/,S' -S *, exit status 2:\n tar: /mnt/backup/katello-backup-2020-08-25-18-13-10/pgsql_data.tar: Wrote only 4096 of 10240 bytes\ntar: Error is not recoverable: exiting now\n--------------------------------------------------------------------------------\nScenario [Backup] failed.\n\nThe following steps ended up in failing state:\n\n  [backup-offline-candlepin-db]\n\nResolve the failed steps and rerun\nthe command. In case the failures are false positives,\nuse --whitelist=\"backup-offline-candlepin-db\"\n\n\nThe runner is already in quit state\n")),Object(o.b)("p",null,'I spent a few days on this issue and tried multiple different avenues. To cut a long story short (re-initiating the backup, rebooting the server, starting PostgreSQL "manually", reading ',Object(o.b)("inlineCode",{parentName:"p"},"journalctl -xe"),"), I decided I needed to cut my losses and revert the VM again. So I took a snapshot of the vm, backed it up, and copied the xml of the broken server. Right now I don't think I have the know-how to fix this, but it could be a good troubleshooting project later on. So onward and upward, after reverting the VM I re-did my work."),Object(o.b)("h3",{id:"importing-errata"},"Importing errata"),Object(o.b)("p",null,"This time I was able to backup my foreman/katello instance properly, but I was unable to import errata. Every time I did try, I would get the following message:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"Skipping errata [...] \u2014 No packages found\n")),Object(o.b)("p",null,"I tried setting ",Object(o.b)("inlineCode",{parentName:"p"},"--include-repo=")," after running ",Object(o.b)("inlineCode",{parentName:"p"},"pulp-admin repo list"),", but that did not result in any errata info as well. I looked at the GitHub page for the perl script to see if anyone else has ran into a similar issue. Sure enough, an ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/rdrgmnzs/pulp_centos_errata_import/issues/27"}),"open issue"),' showed up: "All errata fail to import showing no package found". However it seemed to be a dead end after giving the suggestions a try. Finally I looked at the script itself to see what it was doing, and hopefully where it was failing. I found the spot I was looking for:'),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-clike",metastring:'title="Lines 154-156"',title:'"Lines','154-156"':!0}),"  # Get all packages in current channel\n  my @allpkg = `pulp-admin $pulp_args rpm repo content rpm --repo-id=$repo --fields=filename | grep Filename: | awk '{print \\$2}' `;\n  chomp @allpkg;\n")),Object(o.b)("p",null,"What this told me is that it was using ",Object(o.b)("inlineCode",{parentName:"p"},"pulp-admin rpm repo")," to import/find the relevant information for the errata. I ran ",Object(o.b)("inlineCode",{parentName:"p"},"pulp-admin rpm repo list"),", and got zero repos back. There must have been a step I missed or something was amiss in general because I could not find a way for ",Object(o.b)("inlineCode",{parentName:"p"},"pulp-admin rpm repo")," to recognize and import my existing yum repo. I tried using an alterative script based in python, ",Object(o.b)("inlineCode",{parentName:"p"},"katello-centos-errata-import"),", but I had little luck with that one as well. Once again I felt the need to move on and try at a later time before spinning my wheels for too long."),Object(o.b)("h3",{id:"restoring-the-foreman-vm"},"Restoring the Foreman vm"),Object(o.b)("p",null,"I did make some snapshots of the vm along the way, and decided to rename them since I was starting to not know what the differences were. That seemed like it was a bad idea though - after I set the names of the snapshots to better-suited names than timestamps, I couldn't revert the snapshot to right before I tried to import errata. What was strange is command would ",Object(o.b)("em",{parentName:"p"},"appear")," to execute successfully but I knew it wasn't, if only because it would be too quick to bring the virsh prompt back. After trying others I realized they all had the same issue: they would appear to execute quickly but the vm was still in the same state before applying. Finally I tried applying an old snapshot that still had the timestamp as its name and the snapshot applied correctly."),Object(o.b)("p",null,"I renamed the snapshot I needed to the timestamp and tried to apply the snapshot again. Sure enough, the timestamp-named snapshot restored the vm. At this point I believe I need to cut my losses entirely on Foreman for now, and proceed with the other steps of the Linux sysadmin guide. The guide is to learn about Linux system administration, not just Foreman administration. I am excited to move on to step 3 in the Linux sysadmin guide, which will have me set up named, dhcpd, and having the dhcp use the Foreman server for pxeboot."),Object(o.b)("h3",{id:"hows-linux-going"},"How's Linux going?"),Object(o.b)("p",null,'Excited to move on from Foreman! I may not be "done" with it but I am happy to be able to focus on something else for a little while.'),Object(o.b)("h3",{id:"sources"},"Sources"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.reddit.com/r/OSHA/comments/iiaoyw/this_light_bulb_in_our_walkin_fridge/"}),"Image source")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/rdrgmnzs/pulp_centos_errata_import/"}),"Perl script to import errata")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/rdrgmnzs/pulp_centos_errata_import/blob/master/errata_import.pl#L154-L156"}),"Lines 154-156 of perl script")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://github.com/nicolas-r/katello-centos-errata-import"}),"Python script to import errata"))))}c.isMDXComponent=!0}}]);