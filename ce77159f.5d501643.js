(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{117:function(e,t,s){"use strict";s.r(t),s.d(t,"frontMatter",(function(){return l})),s.d(t,"metadata",(function(){return n})),s.d(t,"rightToc",(function(){return p})),s.d(t,"default",(function(){return b}));var a=s(2),r=s(6),o=(s(0),s(140)),l={id:"pgpool-II-setup",title:"pgpool-II setup",sidebar_label:"pgpool-II setup"},n={unversionedId:"pgpool-II-setup",id:"pgpool-II-setup",isDocsHomePage:!1,title:"pgpool-II setup",description:"On both VMs",source:"@site/docs/pgpool-II-setup.md",slug:"/pgpool-II-setup",permalink:"/docs/pgpool-II-setup",editUrl:"https://github.com/jeremyhager/yugawa-website/edit/master/docs/pgpool-II-setup.md",version:"current",sidebar_label:"pgpool-II setup"},p=[{value:"On both VMs",id:"on-both-vms",children:[{value:"Create archive for postgresql",id:"create-archive-for-postgresql",children:[]}]},{value:"Set up pgpool on postgresql1",id:"set-up-pgpool-on-postgresql1",children:[{value:"Install pgpool-II for postgresql 12",id:"install-pgpool-ii-for-postgresql-12",children:[]},{value:"Install pgpool-II debug tool",id:"install-pgpool-ii-debug-tool",children:[]},{value:"configure postgresql.conf",id:"configure-postgresqlconf",children:[]},{value:"Create postgresql users",id:"create-postgresql-users",children:[]}]},{value:"Allow passwordless ssh on all servers",id:"allow-passwordless-ssh-on-all-servers",children:[{value:"Generate ssh files for root",id:"generate-ssh-files-for-root",children:[]},{value:"Copy public keys into authorized_keys",id:"copy-public-keys-into-authorized_keys",children:[]},{value:"Generate ssh files for postgres",id:"generate-ssh-files-for-postgres",children:[]},{value:"Test passwordless ssh",id:"test-passwordless-ssh",children:[]}]},{value:"Sources",id:"sources",children:[]}],c={rightToc:p};function b(e){var t=e.components,s=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},c,s,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"on-both-vms"},"On both VMs"),Object(o.b)("h3",{id:"create-archive-for-postgresql"},"Create archive for postgresql"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),'sudo su postgres -c "mkdir /var/lib/pgsql/12/archive"\n')),Object(o.b)("h2",{id:"set-up-pgpool-on-postgresql1"},"Set up pgpool on postgresql1"),Object(o.b)("h3",{id:"install-pgpool-ii-for-postgresql-12"},"Install pgpool-II for postgresql 12"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum -y install pgpool-II-pg12\n")),Object(o.b)("h3",{id:"install-pgpool-ii-debug-tool"},"Install pgpool-II debug tool"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo yum -y install pgpool-II-pg12-debuginfo\n")),Object(o.b)("h3",{id:"configure-postgresqlconf"},"configure postgresql.conf"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-clike",metastring:'title="/var/lib/pgsql/12/data/postgresql.conf"',title:'"/var/lib/pgsql/12/data/postgresql.conf"'}),"listen_addresses = '*'\n...\narchive_mode = on\narchive_command = 'cp \"%p\" \"/var/lib/pgsql/12/archive/%f\"'\n...\nmax_wal_senders = 10\n...\nmax_replication_slots = 10\n...\nwal_level = replica\n...\nhot_standby = on\n...\nwal_log_hints = on\n")),Object(o.b)("h3",{id:"create-postgresql-users"},"Create postgresql users"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo su - postgres -c psql\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),"CREATE ROLE pgpool WITH LOGIN;\nCREATE ROLE repl WITH REPLICATION LOGIN;\n\\password pgpool\n\\password repl\n\\password postgres\n")),Object(o.b)("p",null,"Grant pg_monitor to pgpool:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-sql"}),"GRANT pg_monitor TO pgpool;\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-clike",metastring:'title="/var/lib/pgsql/12/data/pg_hba.conf"',title:'"/var/lib/pgsql/12/data/pg_hba.conf"'}),"host    all             all             samenet                 md5\nhost    replication     all             samenet                 md5\n")),Object(o.b)("h2",{id:"allow-passwordless-ssh-on-all-servers"},"Allow passwordless ssh on all servers"),Object(o.b)("h3",{id:"generate-ssh-files-for-root"},"Generate ssh files for root"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="all servers"',title:'"all','servers"':!0}),"sudo ssh-keygen -t rsa -f id_rsa_pgpool\n")),Object(o.b)("p",null,"Copy files to servers"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'}),"sudo scp id_rsa_pgpool.pub jeremy@postgresql2.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql1.pub\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'}),"sudo scp id_rsa_pgpool.pub jeremy@postgresql1.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql2.pub\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text",metastring:'title="expected output"',title:'"expected','output"':!0}),"Password:\nPassword:\nPassword:\njeremy@postgresql1.internal.virtnet's password: \n")),Object(o.b)("p",null,"When asked for passwords, simply hit enter and leave blank. When asked for the user's password to a postgres server enter in the password for that user."),Object(o.b)("h3",{id:"copy-public-keys-into-authorized_keys"},"Copy public keys into authorized_keys"),Object(o.b)("p",null,"Use postgres by creating directories and files, and adjusting permissions:"),Object(o.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"This is normally done via ",Object(o.b)("inlineCode",{parentName:"p"},"ssh-copy-id"),", however for postgres a manual method is needed."))),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo su - postgres -c 'mkdir -p ~postgres/.ssh'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo su - postgres -c 'touch ~postgres/.ssh/authorized_keys'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'}),"sudo sh -c 'cat id_rsa_pgpool_psql2.pub >> ~postgres/.ssh/authorized_keys'\nsudo rm id_rsa_pgpool_psql2.pub\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'}),"sudo sh -c 'cat id_rsa_pgpool_psql1.pub >> ~postgres/.ssh/authorized_keys'\nsudo rm id_rsa_pgpool_psql1.pub\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo su - postgres -c 'chmod 700 ~postgres/.ssh'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo su - postgres -c 'chmod 600 ~postgres/.ssh/authorized_keys'\n")),Object(o.b)("h3",{id:"generate-ssh-files-for-postgres"},"Generate ssh files for postgres"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"sudo su - postgres\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"cd ~/.ssh\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"ssh-keygen -t rsa -f id_rsa_pgpool\n")),Object(o.b)("p",null,"Copy files to servers"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'}),"scp id_rsa_pgpool.pub jeremy@postgresql2.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql-postgres1.pub\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'}),"scp id_rsa_pgpool.pub jeremy@postgresql1.internal.virtnet:/home/jeremy/id_rsa_pgpool_psql-postgres2.pub\n")),Object(o.b)("p",null,"Exit postgres user"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"exit\n")),Object(o.b)("p",null,"Copy psql-postgres.pub files"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql1"',title:'"postgresql1"'}),"sudo sh -c 'cat id_rsa_pgpool_psql-postgres2.pub >> ~postgres/.ssh/authorized_keys'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"rm id_rsa_pgpool_psql-postgres2.pub\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash",metastring:'title="postgresql2"',title:'"postgresql2"'}),"sudo sh -c 'cat id_rsa_pgpool_psql-postgres1.pub >> ~postgres/.ssh/authorized_keys'\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"rm id_rsa_pgpool_psql-postgres1.pub\n")),Object(o.b)("h3",{id:"test-passwordless-ssh"},"Test passwordless ssh"),Object(o.b)("h2",{id:"sources"},"Sources"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://www.pgpool.net/docs/42/en/html/example-cluster.html"}),"pgpool-II and watchdog example")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://unix.stackexchange.com/a/106482"}),"copy via scp")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("a",Object(a.a)({parentName:"li"},{href:"https://stackoverflow.com/a/82278/14952836"}),"run append as root"))))}b.isMDXComponent=!0},140:function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return d}));var a=s(0),r=s.n(a);function o(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,a)}return s}function n(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){o(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}function p(e,t){if(null==e)return{};var s,a,r=function(e,t){if(null==e)return{};var s,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)s=o[a],t.indexOf(s)>=0||(r[s]=e[s]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)s=o[a],t.indexOf(s)>=0||Object.prototype.propertyIsEnumerable.call(e,s)&&(r[s]=e[s])}return r}var c=r.a.createContext({}),b=function(e){var t=r.a.useContext(c),s=t;return e&&(s="function"==typeof e?e(t):n(n({},t),e)),s},i=function(e){var t=b(e.components);return r.a.createElement(c.Provider,{value:t},e.children)},g={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},u=r.a.forwardRef((function(e,t){var s=e.components,a=e.mdxType,o=e.originalType,l=e.parentName,c=p(e,["components","mdxType","originalType","parentName"]),i=b(s),u=a,d=i["".concat(l,".").concat(u)]||i[u]||g[u]||o;return s?r.a.createElement(d,n(n({ref:t},c),{},{components:s})):r.a.createElement(d,n({ref:t},c))}));function d(e,t){var s=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=s.length,l=new Array(o);l[0]=u;var n={};for(var p in t)hasOwnProperty.call(t,p)&&(n[p]=t[p]);n.originalType=e,n.mdxType="string"==typeof e?e:a,l[1]=n;for(var c=2;c<o;c++)l[c]=s[c];return r.a.createElement.apply(null,l)}return r.a.createElement.apply(null,s)}u.displayName="MDXCreateElement"}}]);